---
title: "yield response function"
format:
  html:
    number-sections: true
    number-depth: 1
    theme: flatly
    toc: true
execute:
  echo: true
  message: false
  warning: false
---

## Packages and functions
```{r setup_not_remove, echo=FALSE, include = F}
#--- R functions ---#
library(here)
source(here("codes", "R", "visualize_yield_response_function.R"))
```


# Use it:

```{r}
# plot_yield_response(model = "NO_ANN", n_fields = 5)     # uses N
# plot_yield_response(model = "DO_ANN", n_fields = 5)     # uses N_tilde 
# plot_yield_response(model = "SO_ANN", n_fields = 10) 
# plot_yield_response(model = "NO_RF", n_fields = 5) 
# plot_yield_response(model = "SO_RF", n_fields = 5) 


models_to_compare <- c("NO_ANN", "DO_ANN", "SO_ANN", "NO_RF", "SO_RF")

# 
plot_yield_response("NO_ANN", 1, global_models = models_to_compare)
plot_yield_response("NO_ANN", 5, global_models = models_to_compare)
plot_yield_response("NO_ANN", 10, global_models = models_to_compare)
plot_yield_response("DO_ANN", 1, global_models = models_to_compare)
plot_yield_response("DO_ANN", 5, global_models = models_to_compare)
plot_yield_response("DO_ANN", 10, global_models = models_to_compare)
plot_yield_response("SO_ANN", 1, global_models = models_to_compare)
plot_yield_response("SO_ANN", 5, global_models = models_to_compare)
plot_yield_response("SO_ANN", 10, global_models = models_to_compare)
plot_yield_response("NO_RF",  1, global_models = models_to_compare)
plot_yield_response("NO_RF",  5, global_models = models_to_compare)
plot_yield_response("NO_RF",  10, global_models = models_to_compare)
plot_yield_response("SO_RF",  1, global_models = models_to_compare)
plot_yield_response("SO_RF",  5, global_models = models_to_compare)
plot_yield_response("SO_RF",  10, global_models = models_to_compare)
```




# RMSE

```{r}
# ============================
# create per-sim RMSE table 
# ============================


# ---- Packages ----
library(tidyverse)
library(fs)
library(here)
library(readr)
library(stringr)

EXPECTED_ROWS <- 1440L

# --------
rmse <- function(x, y) sqrt(mean((x - y)^2, na.rm = TRUE))

# number of fields 
parse_n_fields <- function(folder) {
  f <- str_to_lower(folder)
  
  num <- str_match(f, "(_|\\b)(\\d+)_?fields?\\b")[,3]
  if (!is.na(num)) return(as.integer(num))
  
  words <- c("one"=1,"two"=2,"three"=3,"four"=4,"five"=5,
             "ten"=10,"twenty"=20,"thirty"=30,"forty"=40)
  word <- str_match(f, "(one|two|three|four|five|ten|twenty|thirty|forty)_?fields?")[,2]
  if (!is.na(word)) return(words[[word]])
  
  NA_integer_
}

# --- Model name mapping ---
parse_model <- function(folder) {
  f <- str_to_lower(folder)
  
  case_when(
    str_detect(f, "^cf")          ~ "CF",
    str_detect(f, "^rann")        ~ "DO_ANN",
    str_detect(f, "^half_rann")   ~ "SO_ANN",
    str_detect(f, "^simple_ann")  ~ "No_ANN",
    str_detect(f, "^no_rf")       ~ "NO_RF",
    str_detect(f, "^halfrrf")     ~ "SO_RF",
    TRUE                          ~ NA_character_
  )
}

# read RDS, CSV
read_any <- function(f) {
  ext <- tolower(path_ext(f))
  if (ext == "csv") return(read_csv(f, show_col_types = FALSE))
  obj <- tryCatch(readRDS(f), error = function(e) NULL)
  if (!is.null(obj)) return(obj)
  env <- new.env(parent = emptyenv())
  ok <- tryCatch({ nm <- load(f, envir = env); length(nm) > 0 }, error = function(e) FALSE)
  if (ok) return(env[[ls(env)[1]]])
  stop("Unsupported or unreadable file: ", f)
}

read_eonr_file <- function(f) {
  obj <- read_any(f)
  if (is.list(obj) && all(c("pred","true") %in% names(obj))) {
    list(pred = as.numeric(obj$pred), true = as.numeric(obj$true))
  } else if (is.data.frame(obj) && all(c("pred","true") %in% names(obj))) {
    list(pred = as.numeric(obj$pred), true = as.numeric(obj$true))
  } else if (is.data.frame(obj) && all(c("opt_N_hat","opt_N") %in% names(obj))) {
    list(pred = as.numeric(obj$opt_N_hat), true = as.numeric(obj$opt_N))  # CF
  } else if (is.list(obj) && all(c("opt_N_hat","opt_N") %in% names(obj))) {
    list(pred = as.numeric(obj$opt_N_hat), true = as.numeric(obj$opt_N))  # CF list
  } else {
    stop("Unknown structure (need pred/true or opt_N_hat/opt_N): ", f)
  }
}

# list files in dir 
files_in_dir <- function(dir_path) {
  dir_ls(dir_path, type = "file", recurse = TRUE) %>%
    keep(~ str_detect(path_file(.x),
                      regex("^(sim_\\d+(?:_eonr)?|EONR_\\d+)(?:\\.(rds|rda|rdata|csv))?$",
                            ignore_case = TRUE))) %>%
    discard(~ str_detect(path_file(.x), regex("^validation", ignore_case = TRUE))) %>%
    discard(~ grepl("Icon", basename(.x), fixed = TRUE))
}

# extract sim id from filename
extract_sim_id <- function(base) {
  m <- str_match(base, regex("^(?:sim_(\\d+)(?:_eonr)?|EONR_(\\d+))", ignore_case = TRUE))
  coalesce(as.integer(m[,2]), as.integer(m[,3]))
}

row_from_file <- function(f, model, n_f, expected_rows = EXPECTED_ROWS) {
  tryCatch({
    base <- path_ext_remove(path_file(f))
    sim_id <- extract_sim_id(base)
    if (is.na(sim_id)) return(NULL)
    
    e <- read_eonr_file(f)
    n_rows <- length(e$pred)
    
    tibble(
      sim      = sim_id,
      Model    = model,
      `#field` = n_f,
      n_rows   = n_rows,
      RMSE     = rmse(e$pred, e$true),
      ok_rows  = isTRUE(n_rows == expected_rows),
      file     = f
    )
  }, error = function(e) NULL)
}

# --- RMSE table ----
build_rmse_table <- function(base_dir = here("results"),
                             expected_rows = EXPECTED_ROWS) {
  
  dirs <- fs::dir_ls(base_dir, type = "directory", recurse = FALSE) %>%
    keep(~ str_detect(basename(.x),
                      regex("^(cf|rann|half_rann|simple_ann|no_rf|halfrrf)",
                            ignore_case = TRUE)))
  
  map_dfr(dirs, function(dir_path) {
    folder <- path_file(dir_path)
    model  <- parse_model(folder)   
    n_f    <- parse_n_fields(folder)
    
    files <- files_in_dir(dir_path)
    
    map_dfr(files, row_from_file, model = model, n_f = n_f,
            expected_rows = expected_rows)
  }) %>%
    filter(!is.na(Model), !is.na(`#field`), !is.na(RMSE)) %>%
    arrange(Model, `#field`, sim)
}

```

# RMSE run

```{r}
# ---- run it (all models) ----
rmse_tbl_raw <- build_rmse_table(
  base_dir = here("results"),
  expected_rows = EXPECTED_ROWS
)

# save
# write_csv(rmse_tbl_raw, here("results", "rmse_table_all_models.csv"))
#saveRDS(rmse_tbl_raw, here("results", "rmse_tbl_raw.rds"))

```

# his


```{r}


library(dplyr)
library(ggplot2)
library(stringr)

# -- labels for models ---
model_names <- function(models) {
  map <- c(
    "Simple_ANN" = "No_ANN",
    "RANN"       = "DO_ANN",
    "NO_RF"      = "NO_RF",
    "HALFRANN"   = "SO_ANN",
    "HALFRRF"    = "SO_RF",
    "CF"         = "CF"
  )
  # use mapping if available, else leave unchanged
  out <- unname(map[models])
  ifelse(is.na(out), models, out)
}

# --- plotting data ---
rmse_plot_df <- rmse_tbl_raw %>%
  filter(ok_rows) %>%
  mutate(
    row_lab = model_names(Model),
    col_lab = factor(
      `#field`,
      levels = sort(unique(`#field`)),   # discover field counts
      labels = paste0("Number of fields: ", sort(unique(`#field`)))
    )
  )

# --- Check ---
rmse_plot_df %>% count(row_lab, col_lab)

# ------
xmin <- 0
nice_ceiling <- function(x, base = 5) base * ceiling(x / base)
xmax <- nice_ceiling(max(rmse_plot_df$RMSE, na.rm = TRUE), base = 5)

bins <- 25
binwidth <- (xmax - xmin) / bins

# --- Plot ---
p <- ggplot(rmse_plot_df, aes(x = RMSE)) +
  geom_histogram(binwidth = binwidth, boundary = 0, closed = "left") +
  facet_grid(row_lab ~ col_lab, scales = "fixed") +  
  scale_x_continuous(
    limits = c(xmin, xmax),
    breaks = seq(xmin, xmax, length.out = 6),
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  labs(x = "RMSE by iteration", y = "Count") +
  theme_bw() +
  theme(
    strip.text = element_text(face = "bold", size = 16),
    axis.title = element_text(size = 14)
  )

p
# ggsave(here::here("results", "rmse_hist_3rows.png"), p, width = 12, height = 7, dpi = 300)

```

# create rmse_summary

```{r}
# =========
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)

# --- Prepare rmse_df ---
rmse_df <- rmse_tbl_raw %>%
  dplyr::group_by(Model, `#field`, sim) %>%  
  dplyr::summarise(RMSE = dplyr::first(RMSE), .groups = "drop") %>%
  dplyr::mutate(
    # Field labels (auto from unique values)
    field_f = factor(
      `#field`,
      levels = sort(unique(`#field`)),
      labels = paste0(sort(unique(`#field`)),
                      ifelse(sort(unique(`#field`)) == 1, " field", " fields"))
    )
  )

# --- Summary stats ---
rmse_summary <- rmse_df %>%
  dplyr::group_by(Model, field_f) %>%
  dplyr::summarise(
    n      = dplyr::n(),
    mean   = mean(RMSE, na.rm = TRUE),
    median = median(RMSE, na.rm = TRUE),
    sd     = sd(RMSE, na.rm = TRUE),
    se     = sd / sqrt(n),
    lower  = mean + qt(0.025, df = n - 1) * se,
    upper  = mean + qt(0.975, df = n - 1) * se,
    .groups = "drop"
  ) %>%
  # remove 2-field and 4-field combinations
  dplyr::filter(!field_f %in% c("2 fields", "4 fields"))


```

# plot 1


```{r}
# 
p_mean <- ggplot(rmse_summary, aes(x = field_f, y = mean, group = Model, color = Model)) +
  geom_line(linewidth = 0.7, alpha = 0.8) +
  geom_point(size = 3) +
  labs(x = "# fields", y = "Mean RMSE", color = "Model") +
  theme_bw() +
  theme(
    axis.title = element_text(size = 13),
    strip.text = element_text(face = "bold")
  )

p_mean +
  geom_text(aes(label = sprintf("%.1f", mean)), vjust = -0.6, size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.10)))

p_mean


# ggsave(here::here("results","rmse_mean_by_model_fields.png"), p_mean, width = 9, height = 5, dpi = 300)
```

# plot 2


```{r}

fill_min <- floor(min(rmse_summary$mean, na.rm = TRUE))
fill_max <- ceiling(max(rmse_summary$mean, na.rm = TRUE))

p_clear <- ggplot(rmse_summary, aes(x = field_f, y = Model, fill = mean)) +
  geom_tile(color = "white", linewidth = 0.7) +
  geom_text(aes(label = sprintf("%.1f", mean)),
            size = 3.5, fontface = "bold", color = "black") +
  scale_fill_gradient(
    name = "Mean RMSE",
    low = "#f7fbff",  
    high = "#6baed6", 
    limits = c(fill_min, fill_max)
  ) +
  coord_equal() +
  labs(x = "# fields", y = "model") +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    legend.position = "right"
    #plot.margin = margin(10, 10, 10, 10)
  )

p_clear

# ggsave(here::here("results","rmse_mean_graph.png"), p_clear, width = 7.5, height = 4.5, dpi = 300)


```



# table

```{r}

# ------
rmse_summary %>%
  arrange(Model, field_f) %>%
  mutate(`mean (sd)` = sprintf("%.2f (%.2f)", mean, sd)) %>%
  select(Model, field_f, n, `mean (sd)`, median, lower, upper) %>%
  print(n = Inf)

```

# comparison plot

```{r}
# compare to which model?
baseline <- "NO_RF"

# average RMSE by Model Ã— field
avg_by <- rmse_df %>%
  dplyr::group_by(Model, field_f) %>%
  dplyr::summarise(mean_rmse = mean(RMSE), .groups = "drop")

# baseline per field 
baseline_by_field <- avg_by %>%
  dplyr::filter(Model == baseline) %>%
  dplyr::select(field_f, baseline_rmse = mean_rmse)

# join and compute % improvement
rel <- avg_by %>%
  dplyr::left_join(baseline_by_field, by = "field_f") %>%
  dplyr::filter(!is.na(baseline_rmse)) %>%
  dplyr::mutate(
    pct_impr = 100 * (baseline_rmse - mean_rmse) / baseline_rmse
    # or: pct_impr = (1 - mean_rmse / baseline_rmse) * 100
  ) %>%
  dplyr::filter(Model != baseline)

# Plot
library(ggplot2)
p_rel <- ggplot(rel, aes(x = field_f, y = pct_impr, fill = Model)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.65) +
  geom_hline(yintercept = 0, linewidth = 0.4) +
  geom_text(aes(label = sprintf("%.1f%%", pct_impr)),
            position = position_dodge(width = 0.7), vjust = -0.4, size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.10))) +
  labs(x = "# fields", y = sprintf("Improvement vs %s (%%)", baseline), fill = "Model") +
  theme_bw()

p_rel

```

# Best model by the numbers of fields

```{r}
library(dplyr)
library(stringr)

best_models <- rmse_summary %>%
  mutate(field_n = as.numeric(str_extract(field_f, "\\d+"))) %>%
  group_by(field_n) %>%
  #  the best model 
  slice_min(order_by = mean, with_ties = FALSE) %>%
  ungroup() %>%
  # order by RMSE 
  arrange(mean, field_n) %>%
  select(Model, field_f, mean)


## Vis

library(gt)

best_models %>%
  gt() %>%
  tab_header(
    title = "best models by #field",
    subtitle = "Ordered by lowest mean RMSE"
  ) %>%
  fmt_number(
    columns = c(mean),
    decimals = 3
  ) %>%
  cols_label(
    field_f = "# fields",
    mean    = "mean RMSE"
  
  ) %>%
  tab_options(table.font.size = "small")


```
---
title: "Add mean match to YRF"
author: "Your Name Here"
format:
  html:
    number-sections: true
    number-depth: 1
    theme: flatly
    toc: true
execute:
  echo: true
  message: false
  warning: false
---

# Add mean match
```{r setup_not_remove, echo=FALSE, include = F}

suppressPackageStartupMessages({
  library(here)
  library(readr)
  library(dplyr)
  library(stringr)
  library(purrr)
})


base_dir <- here::here("results", "yield_response_function_for_one_iteration")
if (!dir.exists(base_dir)) {
  stop("Base results directory not found: ", base_dir, call. = FALSE)
}

# mean-match predicted yield to true yield 
mean_match_file <- function(csv_path) {
  df <- suppressMessages(readr::read_csv(csv_path, show_col_types = FALSE))

  # Need both columns present
  if (!all(c("pred_yield", "true_yield") %in% names(df))) {
    message("Skipping (missing pred_yield/true_yield): ", csv_path)
    return(invisible(FALSE))
  }

  # global mean-match (single shift per file)
  delta <- mean(df$true_yield, na.rm = TRUE) - mean(df$pred_yield, na.rm = TRUE)

  df <- df %>%
    mutate(pred_yield_mm = pred_yield + delta) %>%
    relocate(pred_yield_mm, .after = pred_yield)

  readr::write_csv(df, csv_path)
  message(sprintf("Updated: %s  (delta = %.6f)", csv_path, delta))
  invisible(TRUE)
}

# find all YRF_* subfolders, but skip NO_* models
subdirs <- list.dirs(base_dir, recursive = FALSE, full.names = TRUE)
targets <- subdirs[!grepl("^YRF_NO_", basename(subdirs), ignore.case = TRUE)]

# process each yield_response_*.csv in folders
walk(targets, function(dir_path) {
  csvs <- list.files(dir_path, pattern = "^yield_response_.*\\.csv$", full.names = TRUE)
  if (!length(csvs)) {
    message("No yield_response_*.csv in: ", dir_path)
    return(invisible(NULL))
  }
  walk(csvs, mean_match_file)
})

```

# CF

```{r}
# ==========================================================
# Mean-match predicted yield ONLY for CF (change # fields)
# ==========================================================
suppressPackageStartupMessages({
  library(here)
  library(readr)
  library(dplyr)
  library(stringr)
  library(purrr)
})

# Base directory
base_dir <- here::here("results", "yield_response_function_for_one_iteration")
target_dir <- file.path(base_dir, "YRF_CF_ten_fields")

if (!dir.exists(target_dir)) {
  stop("Target directory not found: ", target_dir, call. = FALSE)
}

# --- mean-match function (global shift per file) ---
mean_match_file <- function(csv_path) {
  df <- suppressMessages(readr::read_csv(csv_path, show_col_types = FALSE))

  if (!all(c("pred_yield", "true_yield") %in% names(df))) {
    message("Skipping (missing pred_yield/true_yield): ", csv_path)
    return(invisible(FALSE))
  }

  delta <- mean(df$true_yield, na.rm = TRUE) - mean(df$pred_yield, na.rm = TRUE)

  df <- df %>%
    mutate(pred_yield_mm = pred_yield + delta) %>%
    relocate(pred_yield_mm, .after = pred_yield)

  readr::write_csv(df, csv_path)
  message(sprintf("Updated: %s  (delta = %.6f)", csv_path, delta))
  invisible(TRUE)
}

# --- find CF yield_response_*.csv files and apply mean-match ---
csvs <- list.files(target_dir, pattern = "^yield_response_.*\\.csv$", full.names = TRUE)
if (!length(csvs)) {
  message("No yield_response_*.csv in: ", target_dir)
} else {
  walk(csvs, mean_match_file)
}


```
